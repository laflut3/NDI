import { useEffect, useState } from 'react'
import Quiz from './Quiz'

export default function Overlay({ poiData, onClose, onContinue }) {
  const [quizCompleted, setQuizCompleted] = useState(false)
  const [quizResults, setQuizResults] = useState(null)

  // For quiz type, user must complete it to exit
  const canClose = poiData.type !== 'quiz' || quizCompleted

  // Handle ESC key to close modal (only if allowed)
  useEffect(() => {
    const handleEscape = (e) => {
      if (e.key === 'Escape' && canClose) {
        if (onContinue) onContinue(poiData)
        else onClose()
      }
    }

    window.addEventListener('keydown', handleEscape)
    return () => window.removeEventListener('keydown', handleEscape)
  }, [onClose, onContinue, poiData, canClose])

  // Handle quiz completion - mark complete and trigger continue with results
  const handleQuizComplete = (score, percentage, xpEarned) => {
    setQuizCompleted(true)
    setQuizResults({ score, percentage, xpEarned })

    // Trigger parent's onContinue with quiz results attached to POI
    if (onContinue) {
      const poiWithResults = {
        ...poiData,
        quizResults: { score, percentage, xpEarned }
      }
      onContinue(poiWithResults)
    }
  }

  // Render different content based on POI type
  const renderContent = () => {
    switch (poiData.type) {
      case 'quiz':
        return <QuizContent poiData={poiData} onComplete={handleQuizComplete} />
      case 'chatbot':
        return <ChatbotContent poiData={poiData} />
      case 'funfact':
        return <FunFactContent poiData={poiData} />
      default:
        return <DefaultContent poiData={poiData} />
    }
  }
  return (
    <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md animate-fadeIn p-4">
      <div className="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col overflow-hidden animate-slideUp">
        {/* Header with icon and color accent */}
        <div
          className="p-6 text-white relative overflow-hidden flex-shrink-0"
          style={{
            background: `linear-gradient(135deg, ${poiData.color} 0%, ${poiData.color}dd 100%)`
          }}
        >
          <div className="absolute top-0 right-0 text-9xl opacity-10 transform translate-x-8 -translate-y-4">
            {poiData.icon}
          </div>
          <div className="relative z-10">
            <div className="text-5xl mb-3">{poiData.icon}</div>
            <h2 className="text-3xl font-bold mb-2">{poiData.content.heading}</h2>
            <p className="text-white/90 text-sm">
              {poiData.type === 'quiz' && 'Station de Quiz'}
              {poiData.type === 'chatbot' && 'Assistant Num√©rique'}
              {poiData.type === 'funfact' && 'D√©couverte de Faits'}
            </p>
          </div>
        </div>

        {/* Scrollable Content Container */}
        <div className="overflow-y-auto flex-1">
          <div className="p-8">
            {renderContent()}

          {/* Action button - disabled for quiz until completed */}
          {poiData.type !== 'quiz' && (
            <button
              onClick={() => {
                if (onContinue) onContinue(poiData)
                else onClose()
              }}
              className="mt-8 w-full py-4 rounded-xl font-bold text-white text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200"
              style={{
                background: `linear-gradient(135deg, ${poiData.color} 0%, ${poiData.color}cc 100%)`
              }}
            >
              Continuer la Mission ‚Üí
            </button>
          )}
          </div>
        </div>

        {/* Footer - Fixed at bottom */}
        <div className="flex-shrink-0 border-t border-gray-200">
          {poiData.type !== 'quiz' && (
            <div className="px-8 py-4 text-center bg-gray-50">
              <p className="text-gray-500 text-xs">
                Appuyez sur ESC ou cliquez sur le bouton pour reprendre votre mission
              </p>
            </div>
          )}
          {poiData.type === 'quiz' && !quizCompleted && (
            <div className="px-8 py-4 text-center bg-orange-50">
              <p className="text-orange-600 text-sm font-semibold">
                ‚ö†Ô∏è Vous devez terminer le quiz pour continuer
              </p>
            </div>
          )}
        </div>
      </div>

      <style>{`
        @keyframes fadeIn {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }

        @keyframes slideUp {
          from {
            transform: translateY(50px);
            opacity: 0;
          }
          to {
            transform: translateY(0);
            opacity: 1;
          }
        }

        .animate-fadeIn {
          animation: fadeIn 0.3s ease-out;
        }

        .animate-slideUp {
          animation: slideUp 0.4s ease-out;
        }
      `}</style>
    </div>
  )
}

// Quiz POI Content - Renders the actual Quiz component
function QuizContent({ poiData, onComplete }) {
  if (!poiData.quizData) {
    return (
      <div className="text-red-600 p-4">
        Error: Quiz data not found for this POI
      </div>
    )
  }

  return <Quiz quizData={poiData.quizData} onComplete={onComplete} />
}

// Chatbot POI Content
function ChatbotContent({ poiData }) {
  return (
    <div className="space-y-6">
      {/* Introduction */}
      <div className="bg-gradient-to-br from-yellow-50 to-orange-50 p-6 rounded-xl border-2 border-yellow-300">
        <div className="flex items-start gap-4">
          <div className="text-4xl">ü§ñ</div>
          <div>
            <h3 className="text-xl font-bold text-gray-800 mb-2">Assistant Num√©rique NIRD</h3>
            <p className="text-gray-700 leading-relaxed">
              Votre guide personnel pour comprendre l'ind√©pendance num√©rique, les logiciels libres et la sobri√©t√© technologique.
            </p>
          </div>
        </div>
      </div>

      {/* Tips Section */}
      <div className="space-y-4">
        <h4 className="text-lg font-bold text-gray-800 flex items-center gap-2">
          <span>üí°</span>
          <span>Conseils Essentiels pour l'Ind√©pendance Num√©rique</span>
        </h4>

        {/* Tip 1 */}
        <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-5 rounded-xl border-2 border-blue-300">
          <div className="flex items-start gap-3">
            <div className="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">1</div>
            <div>
              <h5 className="font-bold text-gray-800 mb-2">Privil√©giez les Logiciels Libres</h5>
              <p className="text-gray-700 text-sm leading-relaxed">
                Utilisez des alternatives libres comme LibreOffice, GIMP, ou Audacity. Ces logiciels respectent votre libert√©, sont gratuits et peuvent prolonger la vie de votre mat√©riel.
              </p>
            </div>
          </div>
        </div>

        {/* Tip 2 */}
        <div className="bg-gradient-to-br from-green-50 to-green-100 p-5 rounded-xl border-2 border-green-300">
          <div className="flex items-start gap-3">
            <div className="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">2</div>
            <div>
              <h5 className="font-bold text-gray-800 mb-2">Prot√©gez Vos Donn√©es Personnelles</h5>
              <p className="text-gray-700 text-sm leading-relaxed">
                Choisissez des services qui respectent le RGPD et stockent vos donn√©es en Europe. √âvitez les Big Tech qui mon√©tisent vos informations personnelles.
              </p>
            </div>
          </div>
        </div>

        {/* Tip 3 */}
        <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-5 rounded-xl border-2 border-purple-300">
          <div className="flex items-start gap-3">
            <div className="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">3</div>
            <div>
              <h5 className="font-bold text-gray-800 mb-2">Pratiquez la Sobri√©t√© Num√©rique</h5>
              <p className="text-gray-700 text-sm leading-relaxed">
                Supprimez vos vieux e-mails, limitez le streaming HD, et nettoyez votre cloud. Chaque geste compte pour r√©duire l'empreinte carbone du num√©rique.
              </p>
            </div>
          </div>
        </div>

        {/* Tip 4 */}
        <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-5 rounded-xl border-2 border-orange-300">
          <div className="flex items-start gap-3">
            <div className="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">4</div>
            <div>
              <h5 className="font-bold text-gray-800 mb-2">Donnez une Seconde Vie au Mat√©riel</h5>
              <p className="text-gray-700 text-sm leading-relaxed">
                Un ordinateur "obsol√®te" avec Linux peut encore servir pour la bureautique, la navigation et l'√©ducation. Le reconditionnement r√©duit les d√©chets √©lectroniques.
              </p>
            </div>
          </div>
        </div>

        {/* Tip 5 */}
        <div className="bg-gradient-to-br from-red-50 to-red-100 p-5 rounded-xl border-2 border-red-300">
          <div className="flex items-start gap-3">
            <div className="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">5</div>
            <div>
              <h5 className="font-bold text-gray-800 mb-2">Partagez Vos Connaissances</h5>
              <p className="text-gray-700 text-sm leading-relaxed">
                Participez aux communs num√©riques √©ducatifs. Documentez vos solutions, partagez vos ressources et contribuez √† l'autonomie collective.
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* Action Card */}
      <div className="bg-gradient-to-r from-yellow-400 to-orange-400 p-6 rounded-xl text-white">
        <div className="flex items-center gap-4">
          <div className="text-5xl">üöÄ</div>
          <div>
            <h5 className="font-bold text-lg mb-2">Passez √† l'Action !</h5>
            <p className="text-white/90 text-sm">
              Rejoignez la communaut√© NIRD et contribuez au mouvement pour une √©ducation num√©rique responsable, inclusive et durable.
            </p>
          </div>
        </div>
      </div>
    </div>
  )
}

// Fun Fact POI Content
function FunFactContent({ poiData }) {
  return (
    <div className="space-y-6">
      {/* Introduction */}
      <div className="bg-gradient-to-br from-purple-500 to-pink-500 p-6 rounded-xl text-white">
        <div className="flex items-start gap-4">
          <div className="text-4xl">üí°</div>
          <div>
            <h3 className="text-xl font-bold mb-2">Faits Fascinants sur le Num√©rique</h3>
            <p className="text-white/90 leading-relaxed">
              D√©couvrez des informations surprenantes sur la technologie, l'√©cologie num√©rique et l'impact de nos usages quotidiens.
            </p>
          </div>
        </div>
      </div>

      {/* Facts Grid */}
      <div className="space-y-4">
        {poiData.content.facts.map((fact, index) => {
          const emoji = fact.split(' ')[0]
          const text = fact.split(' ').slice(1).join(' ')

          // Assign different gradient colors to each fact
          const gradients = [
            'from-blue-50 to-cyan-50 border-blue-300',
            'from-green-50 to-emerald-50 border-green-300',
            'from-purple-50 to-violet-50 border-purple-300',
            'from-orange-50 to-red-50 border-orange-300',
            'from-pink-50 to-rose-50 border-pink-300',
            'from-yellow-50 to-amber-50 border-yellow-300'
          ]

          return (
            <div
              key={index}
              className={`bg-gradient-to-br ${gradients[index % gradients.length]} p-5 rounded-xl border-2 hover:shadow-lg transition-all hover:scale-[1.02] cursor-default`}
            >
              <div className="flex items-start gap-4">
                <div className="text-4xl flex-shrink-0">{emoji}</div>
                <div className="flex-1">
                  <div className="flex items-center gap-2 mb-2">
                    <div className="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                      {index + 1}
                    </div>
                    <h5 className="font-bold text-gray-800">Fait #{index + 1}</h5>
                  </div>
                  <p className="text-gray-700 leading-relaxed">
                    {text}
                  </p>
                </div>
              </div>
            </div>
          )
        })}
      </div>

      {/* Additional Info */}
      <div className="bg-gradient-to-r from-indigo-50 to-purple-50 p-6 rounded-xl border-2 border-indigo-200">
        <div className="flex items-start gap-4">
          <div className="text-3xl">üìö</div>
          <div>
            <h5 className="font-bold text-gray-800 mb-2">Le Saviez-Vous ?</h5>
            <p className="text-gray-700 text-sm leading-relaxed mb-3">
              Ces faits illustrent l'importance de la sobri√©t√© num√©rique et du r√©emploi du mat√©riel informatique. Chaque geste compte pour r√©duire notre empreinte √©cologique !
            </p>
            <div className="bg-white p-4 rounded-lg">
              <h6 className="font-semibold text-gray-800 text-sm mb-2">Actions Concr√®tes :</h6>
              <ul className="text-gray-700 text-xs space-y-1">
                <li className="flex items-start gap-2">
                  <span className="text-green-600 font-bold">‚úì</span>
                  <span>Recyclez vos anciens appareils √©lectroniques</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-green-600 font-bold">‚úì</span>
                  <span>Utilisez Linux pour prolonger la vie de vos ordinateurs</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-green-600 font-bold">‚úì</span>
                  <span>R√©duisez votre consommation de streaming vid√©o</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-green-600 font-bold">‚úì</span>
                  <span>Partagez ces connaissances avec votre entourage</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      {/* Impact Stats */}
      <div className="grid grid-cols-2 gap-4">
        <div className="bg-gradient-to-br from-green-500 to-emerald-600 p-4 rounded-xl text-white text-center">
          <div className="text-3xl font-bold mb-1">50M</div>
          <div className="text-xs text-white/90">Tonnes de d√©chets √©lectroniques/an</div>
        </div>
        <div className="bg-gradient-to-br from-blue-500 to-cyan-600 p-4 rounded-xl text-white text-center">
          <div className="text-3xl font-bold mb-1">96%</div>
          <div className="text-xs text-white/90">Des serveurs utilisent Linux</div>
        </div>
      </div>
    </div>
  )
}

// Default content for backwards compatibility
function DefaultContent({ poiData }) {
  return (
    <div className="space-y-4">
      {poiData.content.points?.map((point, index) => (
        <div
          key={index}
          className="flex items-start gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors"
        >
          <div
            className="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm"
            style={{ backgroundColor: poiData.color }}
          >
            {index + 1}
          </div>
          <p className="text-gray-700 leading-relaxed text-sm flex-1 pt-1">
            {point}
          </p>
        </div>
      ))}
    </div>
  )
}
